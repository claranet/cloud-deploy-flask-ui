{% extends "base.html" %}

{% set page_title = 'Job %s' % (job['job_id'] or job['_id'] or '-')  %}

{% block page_header %}
    <ul class="nav nav-stacked action-btns">
        <li>
            <a href="/web/jobs/{{ job['_id'] }}/delete"><button class="btn btn-danger" {%- if job['status'] not in ['done', 'failed'] -%}disabled{%-endif-%}><span class="glyphicon glyphicon-trash"></span> Delete</button></a>
        </li>
    </ul>
{% endblock %}"

{% block page_content %}
    {% set app = job['app_id'] or {'_id': 'N/A', 'name': 'N/A', 'env': 'N/A'} %}

    <div class="panel panel-default jobview">
        <div class="panel-heading">Properties</div>
        <div class="panel-body">
            <div class="row">
                {{ ghost_display_field('job-id', 'Job ID', job['job_id'] or '-', cols=2) }}
                {{ ghost_display_field('job-created', 'Created', job['_created'], cols=2) }}
                {{ ghost_display_field('job-app', 'Application', app['name'] + ' (' + app['env'] + ')', '/web/apps/' + app['_id'], cols=2) }}</a>
            </div>
            <div class="row">
                {{ ghost_display_field('job-id', 'Technical ID', job['_id'], cols=2) }}
                {{ ghost_display_field('job-updated', 'Modified', job['_updated'], cols=2) }}
                {{ ghost_display_field('job-command', 'Command', job['command'], cols=2) }}
            </div>
            <div class="row">
                {{ ghost_display_field('job-status', 'Status', job['status'], cols=2) }}
                {{ ghost_display_field('job-role', 'User', job['user'], cols=2) }}
            </div>
            <div class="row">
                {{ ghost_display_field('job-message', 'Message', job['message'], None, 9) }}
            </div>
            <div class="row">
                <table class="table col-md-6">
                    <caption>Options</caption>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for option in job['options'] %}
                            <tr>
                                <th scope="row">{{ loop.index }}</th>
                                <td>{{ option }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
        
                <table class="table col-md-6">
                    <caption>Modules</caption>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Rev</th>
                            <th>Deploy ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for module in job['modules'] %}
                            <tr>
                                <th scope="row">{{ loop.index }}</th>
                                <td>{{ module['name'] }}</td>
                                <td>{{ module['rev'] }}</td>
                                <td>{{ module['deploy_id'] or '-' }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Job log -->
    <div class="panel panel-default jobview">
        <div class="panel-heading logactions">
            <span>Console Output</span>
            <p>
                <a href="#" id="logScrollTop"><button class="btn btn-default" title="Scroll top"><span class="glyphicon glyphicon-arrow-up"></span></button></a>
                <a href="#" id="logScrollBottom"><button class="btn btn-default" title="Scroll bottom"><span class="glyphicon glyphicon-arrow-down"></span></button></a>
            </p>
        </div>
        <div id="log" class="panel-body"></div>
    </div>
    <script type="text/javascript"
        src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
    <!-- Get log content -->
    <script type="text/javascript" charset="utf-8">
        var socket = io.connect();
        socket.on('connect', function() {
            socket.emit('job_logging', {log_id: "{{ job['log_id'] }}" });
        });
        socket.on('job', function(data) {
            $('#log').append(data + '<br>');
        });
    </script> 
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script type="text/javascript">
        $('#logScrollTop').click(function(evt) {
            evt.preventDefault();
            $('#log').animate({ scrollTop: 0 }, "slow");
        });
        $('#logScrollBottom').click(function(evt) {
            evt.preventDefault();
            $('#log').animate({ scrollTop: $('#log').get(0).scrollHeight }, "slow");
        });
    </script>
{% endblock %}
