{% extends "bootstrap/base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% import "bootstrap/utils.html" as util %}

{% block title %}Morea GHOST - {{ page_title }}{% endblock %}

{% block styles %}
    {{super()}}
    <link rel="stylesheet" href="{{url_for('.static', filename='ghost.css')}}">
{% endblock %}

{% block navbar %}
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="pull-left" href="/web/apps"><img alt="Morea GHOST" src="{{ url_for('static', filename='logo.png')}}" /></a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li role="presentation" class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="/web/apps" role="button" aria-expanded="false">
                            Applications <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="/web/apps">List Apps</a></li>
                            <li><a href="/web/apps/create">Create App</a></li>
                        </ul>
                    </li>
                    <li><a href="#about">About (TODO)</a></li>
                </ul>
            </div>
        </div>
    </nav>
{% endblock %}

{% block content %}
    {{ util.flashed_messages() }}
    <div class="container" role="main">
        {% block page_content %}
        {% endblock %}
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        function ghost_add_entry_to_list(group_id, entry_id, entry_label) {
            var count = $("div[data-" + entry_id + "]").size();
            var clone = $("div[data-" + entry_id + "]:first").clone();

            clone.attr("id", entry_id + "_"+(count+1));
            clone.find("h3").text(entry_label + " " + (count+1));
            clone.find("input").each(function() {
                var old_id = $(this).attr('id');
                var new_id = old_id.replace('-0', '-' + count);
                $(this).attr("id", new_id);
                $(this).attr("name", new_id);
                $(this).val(null);

                var field_label = clone.find("label[for='" + old_id + "']");
                field_label.attr("for", new_id);
            });

            clone.appendTo("div#" + group_id + "_list");
        }

        function dropHandler(dropEvent) {
            dropEvent.stopPropagation();
            dropEvent.preventDefault();
            var reader = new FileReader();
            reader.onloadend = function(loadEvent) {
                if (loadEvent.target.readyState == FileReader.DONE) {
                    dropEvent.target.value = loadEvent.target.result;
                }
            };
            reader.readAsText(dropEvent.dataTransfer.files[0],"UTF-8");
        }
    </script>
{% endblock %}

{% macro ghost_fieldlist(fieldlist, group_id, group_label, entry_id, entry_label) -%}
    <h2>{{ group_label }}</h2>
    <div id="{{ group_id }}_list">
        {% for entry in fieldlist %}
            <div id="{{ entry_id }}_{{ loop.index }}" data-{{ entry_id }}>
                <h3>{{ entry_label }} {{ loop.index }}</h3>
                {% if entry.type == 'FormField' %}
                    {% for field in entry if not field.type == 'CSRFTokenField' %}
                        {{ wtf.form_field(field, form_type='horizontal', placeholder='TODO') }}
                    {% endfor %}
                {% else %}
                    {{ wtf.form_field(entry, form_type='horizontal', placeholder='TODO') }}
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <div id="add_{{ entry_id }}_button" class="form-group">
        <div class="col-lg-offset-2 col-lg-10 "> 
            <input class="btn btn-default" id="add-{{ entry_id }}" name="add-{{ entry_id }}" type="button"
                value="Add {{ entry_label }}" onclick="javascript:ghost_add_entry_to_list('{{ group_id }}', '{{ entry_id }}', '{{ entry_label }}')">
        </div>
    </div>
{%- endmacro %}

{% macro ghost_script(value) -%}
    {%- if value | length > 10 -%}
        <abbr title="{{ value }}">
    {%- endif -%}
    {{ value[:10] }}
    {%- if value | length > 10 -%}
        &hellip;</abbr>
    {%- endif %}
{%- endmacro %}

{% macro ghost_display_field(id, name, value) -%}
    <label class="control-label col-md-3" for="{{ id }}">{{ name }}</label>
    <div class="col-md-3" id="{{ id }}">{{ value }}</div>
{%- endmacro %}
