{% extends "bootstrap/base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% import "bootstrap/utils.html" as util %}

{% block title %}Morea GHOST - {{ page_title }}{% endblock %}

{% block styles %}
    {{super()}}
    <link rel="stylesheet" href="{{url_for('.static', filename='css/ghost.css')}}?v={{current_revision}}">
{% endblock %}

{% block navbar %}
    <nav id="header" class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="pull-left" href="/web/apps"><img alt="Morea GHOST" src="{{ url_for('static', filename='logo.png')}}" /></a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li role="presentation" class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="/web/apps" role="button" aria-expanded="false">
                            Applications <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="/web/apps">List Apps</a></li>
                            <li><a href="/web/apps/create">Create App</a></li>
                        </ul>
                    </li>
                    <li><a href="/web/jobs">Jobs</a></li>
                    <li><a href="/web/deployments">Deployments</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="#" class="">{% if current_user.is_authenticated %}Hi {{ current_user.id }}!{% endif %}</a></li>
                </ul>
            </div>
        </div>
    </nav>
{% endblock %}

{% block content %}
    <div class="sidebar">
        <h1 style="overflow: hidden; text-overflow: ellipsis" title="{{ page_title }}">{{ page_title }}</h1>

        <div id="ajaxSpinnerContainer">
            <img src="{{ url_for('static', filename='ajax-loader.gif')}}" id="ajaxSpinnerImage" alt="Loading...">
        </div>

        {% block page_header %}
        {% endblock %}
    </div>

    <div class="container" role="main">
        {{ util.flashed_messages() }}

        {% block page_content %}
        {% endblock %}
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="//cdnjs.cloudflare.com/ajax/libs/autosize.js/1.18.18/jquery.autosize.js?v={{current_revision}}"></script>
    <script type="text/javascript">
        var currentPage = 1;
        var withQuery = $(location).attr('search') && $(location).attr('search') != "";
        $(window).scroll(function()
        {
            if ($(window).scrollTop() == $(document).height() - $(window).height())
            {
                $('tr#loadmoreajaxloader td').show();
                currentPage = currentPage + 1;
                var loadMoreUrl = withQuery
                    ? $(location).attr('href') + '&page=' + currentPage
                    : $(location).attr('href') + '?page=' + currentPage;
                $.ajax({
                    url: loadMoreUrl,
                    success: function(html)
                    {
                        if (html) {
                            $('tr#loadmoreajaxloader').before(html);
                            $('tr#loadmoreajaxloader td').hide();
                        } else {
                            $('tr#loadmoreajaxloader td').html('<span>No more elements to show.</span>');
                            $(window).unbind('scroll');
                        }
                    }
                });
            }
        });
    </script>
    <script>
        $(document).ready(function() {
            $('textarea').autosize();
        });

        var $loading = $('#ajaxSpinnerImage').hide();
        $(document).ajaxStart(function () {
            $loading.show();
        }).ajaxStop(function () {
            $loading.hide();
        });

        function ghost_update_ec2_instancetypes(region) {
          $('#instance_type').find('option').remove();
          $.ajax("/web/aws/regions/" + region + "/ec2/instancetypes").done(function(data) {
              // Update instance types select input options
              $.each(data,function(key, value) {
                $('#instance_type').append('<option value=' + key + '>' + value + '</option>');
              });
          }).fail(function() {
              alert("Failed to retrieve EC2 instance types for region " + region);
          });
        }

        function ghost_update_ec2_vpcs(region) {
          $('#vpc_id').find('option').remove();
          $.ajax("/web/aws/regions/" + region + "/vpc/ids").done(function(data) {
              // Update VPCs select input options
              $.each(data,function(key, value) {
                $('#vpc_id').append('<option value=' + key + '>' + value + '</option>');
              });
              $('select#vpc_id').change();
          }).fail(function() {
              alert("Failed to retrieve EC2 VPCs for region " + region);
          });
        }
        
        function ghost_update_sgs(region, vpc_id) {
          $('[id^=environment_infos-security_groups]').find('option').remove();
          $.ajax("/web/aws/regions/" + region + "/vpc/" + vpc_id + "/sg/ids").done(function(data) {
              // Update SGs select input options
              $.each(data, function(key, value) {
                  $.each($('[id^=environment_infos-security_groups]'), function(index) {
                    $(this).append('<option value=' + key + '>' + value + '</option>');
                  });
              });
          }).fail(function() {
              alert("Failed to retrieve Segurity Groups for region " + region);
          });
        }

        function ghost_update_subnets(region, vpc_id) {
          $('[id^=environment_infos-subnet]').find('option').remove();
          $('#build_infos-subnet_id').find('option').remove();
          $.ajax("/web/aws/regions/" + region + "/vpc/" + vpc_id + "/subnet/ids").done(function(data) {
              // Update Subnets select input options
              $.each(data, function(key, value) {
                  $('#build_infos-subnet_id').append('<option value=' + key + '>' + value + '</option>');
                  $.each($('[id^=environment_infos-subnet]'), function(index) {
                    $(this).append('<option value=' + key + '>' + value + '</option>');
                  });
                  
              });
          }).fail(function() {
              alert("Failed to retrieve Subnet for region " + region + " and VPC id "  + vpc_id);
          });
        }
        
        function ghost_update_amis(region) {
          $('[id^=build_infos-source_ami]').find('option').remove();
          $.ajax("/web/aws/regions/" + region + "/ami/ids").done(function(data) {
              // Update AMIs select input options
              $.each(data, function(key, value) {
                  $.each($('[id^=build_infos-source_ami]'), function(index) {
                    $(this).append('<option value=' + key + '>' + value + '</option>');
                  });
              });
          }).fail(function() {
              alert("Failed to retrieve AMIs");
          });
        }

        $('select#region').change(function() {
            ghost_update_ec2_instancetypes($(this).val());
            ghost_update_ec2_vpcs($(this).val());
            ghost_update_amis($(this).val());
        });
        $('select#vpc_id').change(function() {
            ghost_update_sgs($('select#region').val(), $(this).val());
            ghost_update_subnets($('select#region').val(), $(this).val());
        });

        function ghost_update_command_deploy_revision(module) {
          $.ajax("command/module/" + module).done(function(data) {
              // Update revision input default
              $('#module_rev').val(data);
          }).fail(function() {
              alert("Failed to retrieve last deployed revision for module " + module);
          });
        }

        $('select#module_name').change(function() {
            ghost_update_command_deploy_revision($(this).val())
        });

        function ghost_add_entry_to_list(group_id_prefix, entry_id_prefix, entry_label) {
            var count = $("tr[data-" + entry_id_prefix + "]").size();
            var clone = $("tr[data-" + entry_id_prefix + "]:first").clone();

            clone.attr("id", entry_id_prefix + "_"+(count+1));
            clone.find("input, select, textarea").each(function() {
                var old_id = $(this).attr('id');
                var new_id = old_id.replace('-0', '-' + count);
                $(this).attr("id", new_id);
                $(this).attr("name", new_id);
                $(this).val(null);

                var field_label = clone.find("label[for='" + old_id + "']");
                field_label.attr("for", new_id);
            });

            clone.appendTo("table#" + group_id_prefix + "_list");
        }

        function ghost_del_entry_from_list(entry_del_link, entry_id_prefix) {
            var count = $("tr[data-" + entry_id_prefix + "]").size();
            var entry = $(entry_del_link).parent().parent();
            if (count > 1) {
                entry.remove();
            } else {
                // Do not remove element, just clear inputs
                entry.find("input, select, textarea").val(null);
            }
        }

        function dropHandler(dropEvent) {
            dropEvent.stopPropagation();
            dropEvent.preventDefault();
            var reader = new FileReader();
            reader.onloadend = function(loadEvent) {
                if (loadEvent.target.readyState == FileReader.DONE) {
                    dropEvent.target.value = loadEvent.target.result;
                }
            };
            reader.readAsText(dropEvent.dataTransfer.files[0],"UTF-8");
        }
    </script>

    <script type="text/javascript">
        var positionElementInPage = $('.sidebar').offset().top - 20;
        function updateMenusPositions() {
            if ($(window).scrollTop() >= positionElementInPage) {
                // fixed
                $('.sidebar').next().css('margin-top', $('.sidebar').height() + 'px');
                $('.sidebar').addClass('navbar-fixed-top');
                $('#header').addClass('no-shadow');
            } else {
                // relative
                $('.sidebar').removeClass('navbar-fixed-top');
                $('.sidebar').next().css('margin-top', '0');
                $('#header').removeClass('no-shadow');
            }
            if ($("#left-menu").length > 0) {
                var headingHeight = $('.sidebar').next().offset().top;
                $('#left-menu').css('height', ($(window).height()-headingHeight) + 'px');
                $('#left-menu').css('top', headingHeight + 'px');
            }
        }
        $(window).scroll(function() {
            updateMenusPositions();
        });
        $(window).on('resize', function() {
            updateMenusPositions();
        });
        $(document).ready(function() {
            updateMenusPositions();
        });
    </script>

    {% block page_scripts %}
    {% endblock %}

{% endblock %}

{% macro ghost_fieldlist_entry(entry, entry_id_prefix, entry_label, loop_index, form_type, html_placeholder='') -%}
    <tr id="{{ entry_id_prefix }}_{{ loop_index - 1 }}" data-{{ entry_id_prefix }}>
        <th scope="row" class="col-md-2">
            <a name="{{ entry_id_prefix }}-{{ loop_index - 1 }}" class="anchor">&nbsp</a>
            <span class="index" style="counter-increment: group_entry;">{{ entry_label }}</span>
        </th>
        <td class="col-md-9 {{ form_type }}">
            {% if entry.type == 'FormField' %}
                {% for field in entry if not field.type == 'CSRFTokenField' %}
                    {{ wtf.form_field(field, form_type='horizontal', placeholder=html_placeholder) }}
                {% endfor %}
            {% elif entry.type == 'TextAreaField' %}
                {{ wtf.form_field(entry, form_type='horizontal', dropzone='copy s:text/plain', ondrop='dropHandler(event)', placeholder='Drag and drop a text file here') }}
            {% else %}
                {{ wtf.form_field(entry, form_type='horizontal', placeholder=html_placeholder) }}
            {% endif %}
        </td>
        <td class="col-md-1">
            <a class="btn btn-danger" title="Delete {{ entry_label }}"
                onclick="javascript:ghost_del_entry_from_list(this, '{{ entry_id_prefix }}')">
                <span class="glyphicon glyphicon-remove"></span>
            </a>
        </td>
    </tr>
{%- endmacro %}

{% macro ghost_menulist(fieldlist, group_id_prefix, group_label, entry_id_prefix, entry_label) -%}
<ul class="subnav">
    {% for entry in fieldlist %}
    <li>
        <a href="#{{ entry_id_prefix }}-{{ loop.index - 1 }}">{{ entry.data['module_name'] or 'New module' }}</a>
    </li>
    {% endfor %}
</ul>
{%- endmacro %}

{% macro ghost_fieldlist(fieldlist, group_id_prefix, group_label, entry_id_prefix, entry_label, form_type, html_placeholder='') -%}
    <div class="panel panel-default">
        <div class="panel-heading" style="counter-reset: group_entry;">
            {{ group_label }}
            <a class="btn btn-success" title="Add {{ entry_label }}"
                onclick="javascript:ghost_add_entry_to_list('{{ group_id_prefix }}', '{{ entry_id_prefix }}', '{{ entry_label }}')">
                <span class="glyphicon glyphicon-plus"></span>
            </a>
        </div>
        <table class="table" id="{{ group_id_prefix }}_list">
            <tbody>
            {% for entry in fieldlist %}
                {{ ghost_fieldlist_entry(entry, entry_id_prefix, entry_label, loop.index, form_type, html_placeholder) }}
            {% endfor %}
            </tbody>
        </table>
    </div>
{%- endmacro %}

{% macro ghost_script(value) -%}
    {%- if value | length > 10 -%}
        <abbr title="{{ value }}">
    {%- endif -%}
    {{ value[:10] }}
    {%- if value | length > 10 -%}
        &hellip;</abbr>
    {%- endif %}
{%- endmacro %}

{% macro ghost_display_field(id, name, value, href=None, cols=4, labelcols=2) -%}
    <label class="control-label col-md-{{ labelcols }}" for="{{ id }}">{{ name }}</label>
    <div class="col-md-{{ cols }}" id="{{ id }}">
        {%- if href -%}<a href="{{ href }}">{%- endif -%}
        {{ value }}
        {%- if href -%}</a>{%- endif -%}
    </div>
{%- endmacro %}
