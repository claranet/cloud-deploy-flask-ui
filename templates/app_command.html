{% extends "base.html" %}

{% set page_title = 'Run Command on %s (%s)' % (app['name'], app['env']) %}

{% block page_content %}
    <form class="form-horizontal" method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <label class="control-label col-lg-2 required">Application</label><div class="col-lg-10"><div class="form-control">{{ app['name'] }}</div></div>
        </div>
        <div class="form-group">
            <label class="control-label col-lg-2">Environment</label><div class="col-lg-10"><div class="form-control">{{ app['env'] }}</div></div>
        </div>
        {{ form.hidden_tag() }}

        {{ wtf.form_field(form.command, form_type='horizontal') }}

        <div class="command_options">
            <div class="wrap modules">{{ ghost_command_fieldlist(form.modules, 'modules', 'Modules', 'module', 'inline') }}</div>
            <div class="wrap deploy_id">{{ wtf.form_field(form.deploy_id, form_type='horizontal') }}</div>
            <div class="wrap fabric_execution_strategy">{{ wtf.form_field(form.fabric_execution_strategy, form_type='horizontal') }}</div>
            <div class="wrap safe_deployment">{{ wtf.form_field(form.safe_deployment, form_type='horizontal') }}</div>
            <div class="wrap safe_deployment_strategy">{{ wtf.form_field(form.safe_deployment_strategy, form_type='horizontal') }}</div>
            <div class="wrap instance_type">{{ wtf.form_field(form.instance_type, form_type='horizontal') }}</div>
            <div class="wrap skip_salt_bootstrap">{{ wtf.form_field(form.skip_salt_bootstrap, form_type='horizontal') }}</div>
            <div class="wrap subnet">{{ wtf.form_field(form.subnet, form_type='horizontal') }}</div>
            <div class="wrap private_ip_address">{{ wtf.form_field(form.private_ip_address, form_type='horizontal') }}</div>
        </div>
        {{ wtf.form_field(form.submit, form_type='horizontal') }}
    </form>
{% endblock %}

{% block page_scripts %}
    <script type="text/javascript">
    (function() {
        function show_options_fields()  {
            $('.wrap').hide();
            if ($('#command').val() == 'deploy') {
                $('.wrap.modules').show();
                $('.wrap.fabric_execution_strategy').show();
                $('.wrap.safe_deployment').show();
            } else if ($('#command').val() == 'redeploy') {
                $('.wrap.deploy_id').show();
                $('.wrap.fabric_execution_strategy').show();
                $('.wrap.safe_deployment').show();
            } else if ($('#command').val() == 'buildimage') {
                $('.wrap.instance_type').show();
                $('.wrap.skip_salt_bootstrap').show();
            } else if ($('#command').val() == 'createinstance') {
                $('.wrap.subnet').show();
                $('.wrap.private_ip_address').show();
            }
        }

        function refresh_options_list() {
            $('#command option, #safe_deployment_strategy option').each(function() {
                cmd = $(this).val();
                desc = $(this).text();
                $(this).text(cmd);
                $(this).attr('data-subtext', ' - ' + desc);
            });
            $('#command, #safe_deployment_strategy').selectpicker('refresh');
        }

        function get_app_safe_deployment_possibilities() {
          app_id = '{{ app['_id'] }}';
          $('#safe_deployment_strategy').find('option').remove();
          $.ajax("/web/apps/" + app_id + "/command/deploy/safe_possibilities").done(function(data) {
              $.each(data, function(key, value) {
                $('#safe_deployment_strategy').append('<option value=' + key + '>' + value + '</option>');
              });
              refresh_options_list();
          }).fail(function() {
              alert("Failed to retrieve Safe Deployment Strategies");
          });
        }

        show_options_fields();
        $('#command').change(function() {
            show_options_fields();
        });
        $('#safe_deployment').change(function() {
            if ($(this).is(':checked')) {
                $('.wrap.safe_deployment_strategy').show();
                get_app_safe_deployment_possibilities();
            } else {
                $('.wrap.safe_deployment_strategy').hide();
            }
        });

        refresh_options_list();
    })();

    function ghost_update_command_deploy_revision(module_name, revision_id) {
      $.ajax("command/module/" + module_name).done(function(data) {
          // Update revision input default
          $('#' + revision_id).val(data);
      }).fail(function() {
          alert("Failed to retrieve last deployed revision for module " + module_name);
      });
    }

    function ghost_count_checked_modules() {
       var checked_modules_count = $('input[type="checkbox"][id^="modules"]:checked').length
       $('#module_counter span').text(checked_modules_count);
    }

    $('input[type="checkbox"][id^="modules"]').change(function() {
        if ($(this).prop('checked')) {
            var module_prefix = $(this).attr('id').substr(0, $(this).attr('id').lastIndexOf("-"))
            var name_id = module_prefix + '-name'
            var revision_id = module_prefix + '-rev'
            var module_name = $('input[type="hidden"][id=' + name_id + ']').attr('value')
            ghost_update_command_deploy_revision(module_name, revision_id)
        }
        ghost_count_checked_modules()
    });

    $('#deploy_all_modules').change(function () {
        $('input[type="checkbox"][id^="modules"]').prop('checked', $(this).prop('checked')).trigger("change");
    });
    </script>
{% endblock %}

{% macro ghost_command_fieldlist_entry(entry, entry_id_prefix, loop_index, form_type, html_placeholder='') -%}
    <tr id="{{ entry_id_prefix }}_{{ loop_index - 1 }}" data-{{ entry_id_prefix }}>
            {% if entry.type == 'FormField' %}
                {{ entry.hidden_tag() }}
                {% for field in entry if not field.type == 'CSRFTokenField'and not field.type == 'HiddenField' %}
                <td class="{{ form_type }}">
                    {{ wtf.form_field(field, form_type='horizontal', placeholder=html_placeholder) }}
                </td>
                {% endfor %}
            {% elif entry.type == 'TextAreaField' %}
                <td class="{{ form_type }}">
                    {{ wtf.form_field(entry, form_type='horizontal', dropzone='copy s:text/plain', ondrop='dropHandler(event)', placeholder='Drag and drop a text file here') }}
                </td>
            {% else %}
                <td class="{{ form_type }}">
                    {{ wtf.form_field(entry, form_type='horizontal', placeholder=html_placeholder) }}
                </td>
            {% endif %}
    </tr>
{%- endmacro %}

{% macro ghost_command_fieldlist(fieldlist, group_id_prefix, group_label, entry_id_prefix, form_type, html_placeholder='') -%}
    <div class="form-group">
        <label class="control-label col-lg-2">{{ group_label }}</label>
          <div class="col-lg-10">
            <div class="modules_list">
            <table class="table" id="{{ group_id_prefix }}_list">
                <thead>
                    <tr>
                        <td>
                            <div class="checkbox">
                                <label>
                                    <input id="deploy_all_modules" type="checkbox"> Deploy all modules
                                </label>
                            </div>
                        </td>
                    </tr>
                </thead>
                <tbody>
                {% for entry in fieldlist %}
                    {{ ghost_command_fieldlist_entry(entry, entry_id_prefix, loop.index, form_type, html_placeholder) }}
                {% endfor %}
                </tbody>
            </table>
            </div>
            <div id="module_counter">
                <label>
                    Deployed Modules : <span>0</span>
                </label>
            </div>
        </div>
    </div>
{%- endmacro %}
