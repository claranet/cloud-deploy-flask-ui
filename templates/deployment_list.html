{% extends "base.html" %}

{% set page_title = 'Deployments' %}

{% block page_header %}
    <caption>Sorted by timestamp descending</caption>
{% endblock %}"

{% block page_content %}
    <table class="table">
        <thead>
            <tr>
                <th>#</th>
                <th>Deployment</th>
                <th>Application</th>
                <th>Job</th>
                <th>Module / Path / Package</th>
                <th>Revision</th>
                <th>Commit</th>
                <th>Timestamp</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for deployment in deployments | sort(reverse=True, attribute='_created') %}
                {% set app = deployment['app_id'] or {'_id': 'N/A', 'name': 'N/A', 'env': 'N/A'} %}
                {% set job = deployment['job_id'] or {'_id': 'N/A', 'user': 'N/A', '_created': 'N/A', '_created': '_updated'} %}
            <tr>
                <th scope="row">{{ loop.index }}</th>
                <td style="white-space:nowrap;">
                    <a href="/web/deployments/{{ deployment['_id'] }}">{{ deployment['_id'] }}</a>
                </td>
                <td style="white-space:nowrap;">
                    <a href="/web/apps/{{ app.get('_id', '') }}">{{ app.get('name') }} ({{ app.get('env') }})</a>
                </td>
                <td style="white-space:nowrap;">
                    <a href="/web/jobs/{{ job.get('_id', '') }}">{{ job.get('_id', '') }}</a>
                    <br>
                    {{ job['user'] }}
                    <br>
                    {{ job['_created'] }}
                    <br>
                    {{ job['_updated'] }}
                </td>
                <td style="white-space:nowrap;">
                    {{ deployment['module'] }}
                    <br>
                    {{ deployment['module_path'] }}
                    <br>
                    {{ deployment['package'] }}
                </td>
                <td style="white-space:nowrap;">{{ deployment['revision'] }}</td>
                <td style="white-space:nowrap;">
                    <abbr title="{{ deployment['commit_message'] }}">{{ deployment['commit'] }}</abbr>
                </td>
                <td style="white-space:nowrap;">{{ deployment['timestamp'] }}</td>
                <td style="white-space:nowrap;">
                    <a href="/web/deployments/{{ deployment['_id'] }}/rollback"><button class="btn btn-default">Rollback</button></a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}
